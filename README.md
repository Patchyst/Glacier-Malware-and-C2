# Glacier-Malware-and-C2
Glacier is an open source, educational malware with a custom C2 infrastructure.

# Disclaimer
DO NOT use this project for purposes other than legitimate red teaming/pentesting jobs, or research. DO NOT use this for illegal activity of any kind, and know that this project is intended for research and learning purposes.
## motivations for this project
I wanted to get a better understanding of basic malware development techniques such as, obfuscation, persistence, and data exfiltration. I also wanted to get a basic understanding of how C2 servers are structured, hence the custom C2. Any suggestions on improvements or future projects are greatly appreciated!

# Win32 Agent functionality
* Communicates via HTTP using a custom symmetric encryption for obfuscation
* navigate the a victim's file system using a custom dir implementation
* view file contents
* download files from infected windows device
* upload files to infected windows device
* execute files on infected windows device
* download saved network names/security information, including passwords

## Anti-analysis techniques
### Static
* suspicious functions for editing the registry and executing malicious files are hidden from the IAT by dynamically resolving the function addresses at runtime
* suspicious strings are obfuscated at compile time and decrypted at runtime

### Dynamic
* Basic hardware checks on processor count and RAM are used to detect if the agent may be running in a sanbox/VM
### Custom HTTP encryption
Each agent receives a random, 12 character name when registering with the C2 server. A key is then derived from the name and used to encrypt all communications between the C2 and agent. This ensures that no one, hardcoded key existes within all agents.

## Persistence 

### Program without elevated privileges
The malware is simply added as a run key in HKCU

### Program with elevated privileges
If the malware is run with elevated privleges, it uses a much more stealthy persistence mechanism which does not show up in autoruns.exe. 
I got this mechanism from [this blog](https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/) by ODDVAR MOE. Essentially, the agent can run when a selected exe exits.
The current agent attaches itself to the following executables and will run when they exit:
* Notepad.exe
* OneDrive.exe
* winword.exe
I chose these executables because they are on nearly all windows devices and are opened and closed frequently.

The agent also adds itself to the HKLM run key if the ```writeToRun``` variable is set to true when the agent is compiled

